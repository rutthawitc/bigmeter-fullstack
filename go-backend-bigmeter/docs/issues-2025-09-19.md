BigMeter — Issues Log (2025-09-19)

Scope
- Track blockers and decisions encountered while wiring Oracle → Postgres sync in your environment.

Summary of Changes Today
- Switched sync to thick client only (godror + Oracle Instant Client).
- Simplified sync CLI with two modes:
  - `MODE=ora-test`: ping + quick EXISTS probe
  - `MODE=init-once`: yearly snapshot (top-200 unique customers per branch/month) upserted into Postgres
- Updated minimal SQL to return unique 200 results using `ROW_NUMBER()` and fully-qualified tables under `PWACIS`.

Build/Runtime Issues
- Go module fetch for godror
  - Symptom: `unknown revision v0.xx.x` during `go mod download`.
  - Action: Avoided pinning; Dockerfile pulls `github.com/godror/godror@latest` with `GOPROXY=https://proxy.golang.org,direct`.
  - Status: Resolved in Docker build.

- GLIBC mismatch
  - Symptom: `/app/sync: ... GLIBC_2.38 not found` when running container.
  - Root cause: Builder image linked against newer glibc than runtime.
  - Action: Aligned to Bookworm for both build and runtime (golang:1.25-bookworm → debian:bookworm-slim).
  - Status: Resolved.

Oracle Connectivity Issues
- Thin (go-ora) timeouts
  - Symptom: `read tcp ...: i/o timeout` on count-heavy queries behind SCAN via Docker.
  - Action: Moved to thick client; recommended using node VIP instead of SCAN when possible.

- Thick (godror) handshake close
  - Symptom: `ORA-12537: TNS:connection closed` during connect using SCAN (`cis3-scan.pwa.co.th`).
  - Likely causes: SCAN/LB redirect or server network policies closing handshake from Docker network.
  - Recommended mitigations:
    - Use node VIP instead of SCAN: `USER/PASS@<db-node-ip>:1521/PWACIS`.
    - Use explicit DESCRIPTION with dedicated server:
      `USER/PASS@"(DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=<db-node-ip>)(PORT=1521))(CONNECT_DATA=(SERVER=DEDICATED)(SERVICE_NAME=PWACIS)))"`
    - Validate port reachability from compose network using `nc -vz <db-node-ip> 1521`.
    - If native network encryption is required, mount `sqlnet.ora` via TNS_ADMIN.
  - Status: Pending test with node VIP / DESCRIPTION.

Data Semantics
- `DEBT_YM` stored in Oracle as Buddhist year (e.g., Oct 2024 → `256710`).
  - CLI binds `:DEBT_YM` exactly as provided; pass Thai YYYYMM.
  - Fiscal-year labels in Postgres remain Gregorian (2025 for Oct 2024–Sep 2025).

Why 124 < 200 rows on init
- Upsert key is `(fiscal_year, branch_code, cust_code)`. Oracle “top‑200” may contain duplicate `cust_code`. The revised SQL selects one highest‑usage row per `cust_code` before limiting, targeting up to 200 unique customers.

Operational How‑To
- Diagnostic:
  - `docker compose run --rm -e MODE=ora-test -e BRANCHES='1063' -e DEBT_YM=256710 -e ORACLE_DSN='USER/PASS@<db-node-ip>:1521/PWACIS' sync`
- Yearly init:
  - `docker compose run --rm -e MODE=init-once -e BRANCHES='1063' -e DEBT_YM=256710 -e ORACLE_DSN='USER/PASS@<db-node-ip>:1521/PWACIS' sync`

Next Steps
- Try node VIP or DESCRIPTION DSN with thick driver; confirm with `MODE=ora-test` before running init.
- If encryption/auth policies apply, provide `sqlnet.ora` via TNS_ADMIN volume and re-test.
- Once yearly init stabilizes, add `MODE=month-once` for monthly details in thick mode.

