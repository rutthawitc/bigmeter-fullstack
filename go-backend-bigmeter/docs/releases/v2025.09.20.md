# Release v2025.09.20 — 2025-09-20

This release enriches the yearly snapshot, speeds up init sync, trims monthly details payloads, adds API search/sort, and cleans JSON by omitting nulls.

## Highlights
- Faster yearly init via optimized minimal SQL (limit-then-join).
- `bm_custcode_init` stores richer fields (migration 0004).
- API search/sort across many descriptive fields.
- API omits nullable fields from JSON.

## Changes
- Migration: `migrations/0004_extend_custcode_init.sql` adds
  - `org_name, use_name, cust_name, address, route_code, meter_size, meter_brand` to `bm_custcode_init`.
- SQL:
  - `sqls/200-meter-minimal.sql`: returns richer columns; refactored to dedup + top‑200 before heavy joins.
  - `sqls/200-meter-details.sql`: trimmed to core fields for speed (other text fields null in Postgres).
- API:
  - `/api/v1/custcodes`: exposes new fields; supports search/sort on many columns.
  - `/api/v1/details`: expanded search/sort; nullable fields omitted via `omitempty`.

## Upgrade Steps
1) Stop services (optional):
   - `docker compose down`
2) Apply migrations:
   - `docker compose --profile setup run --rm migrate`
3) Rebuild images (ensures updated SQL/handlers):
   - `docker compose up -d --build`
4) (Optional) Re-seed branches if needed:
   - `docker compose --profile setup run --rm seed_branches`

## Usage Notes
- Searching
  - Custcodes: `q` matches `cust_code, meter_no, use_type, org_name, use_name, cust_name, address, route_code, meter_size, meter_brand, meter_state, debt_ym`.
  - Details: `q` matches `cust_code, meter_no, cust_name, address, route_code, org_name, use_type, use_name`.
- Sorting
  - See README “Search/Sort” for allowlists per endpoint.
- JSON
  - Nullable fields are omitted from responses (no explicit `null`).

## Compatibility
- Clients expecting keys with `null` values should handle missing keys (omitted when null).

## Verify
- Health: `GET /api/v1/healthz`
- Custcodes: `GET /api/v1/custcodes?branch=1063&ym=202410&order_by=org_name&sort=ASC`
- Details: `GET /api/v1/details?branch=1063&ym=202410&order_by=present_water_usg&sort=DESC`

## Tag
- `v2025.09.20`

---
If using GitHub CLI, you can publish this as the release body:
```
# Push tag first (if not yet pushed)
git push origin v2025.09.20

# Create GitHub release
gh release create v2025.09.20 \
  --title "Release v2025.09.20" \
  --notes-file docs/releases/v2025.09.20.md
```
