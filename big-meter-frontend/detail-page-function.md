# รายละเอียดฟังก์ชันหน้ารายงานผู้ใช้น้ำรายใหญ่ (Detail Page)

เอกสารนี้อธิบาย “หน้าที่/พฤติกรรม” ของหน้ารายงาน โดยไม่กล่าวถึงงานออกแบบ UI/สไตล์ภาพ รวมถึงชื่อคอมโพเนนต์และ API ที่เกี่ยวข้องเพื่ออ้างอิงการพัฒนาและทดสอบ

## วัตถุประสงค์

- แสดงรายชื่อผู้ใช้น้ำรายใหญ่ (Top-200 ต่อสาขา) ในเดือนรายงานที่เลือก
- วิเคราะห์การเปลี่ยนแปลงหน่วยน้ำ “เดือนล่าสุด” เทียบกับ “เดือนก่อนหน้า” ตามเกณฑ์เปอร์เซ็นต์ที่กำหนด
- อำนวยความสะดวกในการค้นหา กรอง และแบ่งหน้า เพื่อใช้งานได้ลื่นไหล

## ขอบเขต (ไม่รวม)

- ไม่รวมการออกแบบหน้าตา/สี/สไตล์ (จะจัดทำแยก)
- ไม่รวมระบบยืนยันตัวตน/สิทธิ์ใช้งาน
- ไม่รวมการส่งออกไฟล์ (Export) แบบสมบูรณ์ — ระบุเป็นงานต่อยอดได้

## คำจำกัดความสำคัญ

- เดือนรายงาน (Report Month, `ym`): รูปแบบ `YYYYMM` (ค.ศ.)
- สาขา (Branch): รหัสสาขา เช่น `BA01`
- เกณฑ์เปอร์เซ็นต์ผลต่าง (Threshold): ค่าจำนวนเต็ม 0–100 หมายถึง “ลดลงมากกว่าหรือเท่ากับค่าที่กำหนด” จะถูกนับว่าเข้าเงื่อนไข
- “ล่าสุด” หมายถึงเดือนที่ผู้ใช้เลือกเป็นเดือนรายงาน และ “ก่อนหน้า” คือเดือนที่ถัดขึ้นไปหนึ่งเดือนตามลำดับเวลา

## ฟังก์ชันหลัก

- ตัวกรองข้อมูล (Filters)
  - เลือก “เดือน/ปี” ของรายงาน (`ym`) ด้วยตัวเลือกปี/เดือน
  - เลือก “สาขา” จากรายชื่อสาขาที่ระบบมี (อ่านจาก API)
  - ป้อน “เปอร์เซ็นต์ผลต่าง (การใช้น้ำลดลง)” เป็นตัวเลขจำนวนเต็ม 0–100 (ดีฟอลต์ 10)
  - ปุ่ม “ล้างค่า” รีเซ็ตค่าตัวกรองสู่ดีฟอลต์ (branch ว่าง, threshold=10, จำนวนเดือนย้อนหลังกลับค่าเริ่ม)
  - ปุ่ม “แสดงรายงาน” เป็นตัวเปิดการประมวลผล/แสดงผล (ก่อนกดจะไม่โหลดข้อมูล)

- ช่วงข้อมูลย้อนหลัง
  - ปุ่มเลือก 3 / 6 / 12 เดือนควบคุมจำนวนคอลัมน์ย้อนหลังที่แสดง
  - ค่าเริ่มต้นคือ 6 เดือน และรีเซ็ตกลับเมื่อกด “ล้างค่า”

- การค้นหาในตาราง (Client‑side Search)
  - กล่องค้นหากรองผลลัพธ์แบบฝั่งหน้าเว็บทันที (ไม่ยิง API เพิ่ม)
  - ค้นหาจากหลายฟิลด์รวมกันแบบ case‑insensitive: `org_name, cust_code, use_type, use_name, cust_name, address, route_code, meter_no, meter_size, meter_brand, meter_state`

- ตารางผลลัพธ์
  - หัวตาราง: ลำดับ, กปภ.สาขา, เลขที่ผู้ใช้น้ำ, ประเภท, รายละเอียด, ชื่อผู้ใช้น้ำ, ที่อยู่, เส้นทาง, หมายเลขมาตร, ขนาดมาตร, ยี่ห้อ, สถานะมาตร, หน่วยน้ำเฉลี่ย, (เลขมาตรที่อ่านได้), หน่วยน้ำเดือนนี้, เดือนย้อนหลัง N คอลัมน์
  - คอลัมน์ “หน่วยน้ำเดือนนี้” แสดงค่าเดือนล่าสุดพร้อม “เปอร์เซ็นต์เปลี่ยนแปลงเทียบเดือนก่อนหน้า” เป็น badge
    - ถ้าเดือนก่อนหน้าเป็น 0 ให้แสดงเฉพาะค่าปัจจุบันโดยไม่คำนวณเปอร์เซ็นต์
    - กฎสี badge:
      - ลดลง > 30%: ระดับรุนแรง (error)
      - ลดลง 15–30%: ระดับเตือน (warning)
      - ลดลง 5–15%: ระดับเตือนอ่อน (warning outline)
      - ไม่ลดลงหรือเพิ่มขึ้น: ไม่ลงสี (ghost)
    - เมื่อ hover ที่ค่าเดือนล่าสุด จะแสดง tooltip พร้อม sparkline แนวโน้มย้อนหลัง (แสดงจุดเริ่ม/สิ้นสุดและค่า min/max)
  - “เดือนย้อนหลังทั้งหมด” (รวมเดือนก่อนหน้า) แสดงเป็นตัวเลขธรรมดา “ไม่ลงสี” ตามข้อกำหนดล่าสุด
  - รูปแบบตัวเลข: ใช้ `th-TH` สำหรับจำนวนเต็ม/ทศนิยม (สูงสุด 2 ตำแหน่ง) และแสดงเปอร์เซ็นต์ 1 ตำแหน่งทศนิยม
  - มุมมองหน้าจอเล็ก (ความกว้าง < 768px) จะซ่อนคอลัมน์รองทั้งหมด เหลือเพียง ลำดับ, เลขที่ผู้ใช้น้ำ, ชื่อผู้ใช้น้ำ, ที่อยู่, ขนาดมาตร, หน่วยน้ำเฉลี่ย, เลขมาตรที่อ่านได้ และแสดงย้อนหลังเฉพาะ 3 เดือนล่าสุด
  - ปุ่ม `Export` ดาวน์โหลดไฟล์ `.xlsx` ครอบคลุมข้อมูลย้อนหลัง 12 เดือน (ตามตัวกรองปัจจุบัน) รองรับภาษาไทย
  - เมื่อเข้าสู่ระบบ ค่าเริ่มต้นของตัวเลือก "สาขา" จะพยายามตรงกับ `user.ba` หากไม่มีให้ปล่อยว่าง ("เลือกสาขา")

- การแบ่งหน้า (Client‑side Pagination)
  - เลือกจำนวนรายการต่อหน้า: 10 / 25 / 50 (ดีฟอลต์ 10)
  - ปุ่ม « ก่อนหน้า, หมายเลขหน้า (มี … คั่น), และ ถัดไป »
  - เมื่อเปลี่ยนตัวกรอง/ค้นหา/จำนวนต่อหน้า จะรีเซ็ตไปหน้า 1

- การโหลด/ข้อผิดพลาด
  - แสดงสถานะกำลังโหลด (spinner) ระหว่างดึงข้อมูล
  - แสดงข้อความข้อผิดพลาดกรณี API ตอบกลับผิดพลาด
  - แสดงตัวเลขสรุป “ผลลัพธ์: N รายชื่อ ที่เข้าเงื่อนไข”

## การดึงข้อมูล (Data Fetching)

- แหล่งข้อมูลและโครงสร้าง
  - ดึง “รายชื่อ Top‑200” สำหรับสาขาและเดือนล่าสุดจาก `GET /api/v1/custcodes?branch=BAxx&ym=YYYYMM&limit=200`
  - ดึง “รายละเอียดรายเดือน” สำหรับแต่ละเดือนในช่วงที่ต้องแสดงจาก `GET /api/v1/details?branch=BAxx&ym=YYYYMM&limit=200&order_by=present_water_usg&sort=DESC`
  - รวมข้อมูล: ใช้รายการจาก `custcodes` เป็นเมล็ดตั้งต้น (อย่างน้อย 200 แถว) แล้วเติมค่าหน่วยน้ำของแต่ละเดือนจาก `details` โดยแมปด้วย `cust_code`
  - แถวข้อมูลประกอบด้วยฟิลด์บรรยาย (จาก `custcodes`/`details`) และ `values: Record<ym, number>` เก็บหน่วยน้ำของแต่ละเดือน

- กลไกแคช/คิวรี
  - ใช้ TanStack Query (`@tanstack/react-query`) กับ `queryKey` แยกตาม `['details', {branch, ym}]` และ `['custcodes', {branch, ym}]`
  - ค่าเริ่มต้นของ QueryClient: `retry=1`, `staleTime=60s`, `refetchOnWindowFocus=false`
  - URL สร้างผ่านยูทิล `buildUrl` (รองรับ base URL จาก `VITE_API_BASE_URL` และ dev proxy `/api`)

## ตรรกะแสดงผลและการกรอง (Business Rules)

- เกณฑ์เข้าเงื่อนไข (Threshold)
  - แสดงทุกรายการเมื่อ threshold = 0
  - เมื่อ threshold > 0: นับว่า “เข้าเงื่อนไข” หากเปอร์เซ็นต์เปลี่ยนแปลงของเดือนล่าสุดเทียบเดือนก่อนหน้า `<= -threshold`

- การจัดเดือนแสดงผล
  - ระบบสร้างลิสต์เดือนย้อนหลังจากเดือนล่าสุดตามจำนวนที่กำหนด (เช่น 12, 6, 3)
  - ลำดับเดือนในตาราง: เริ่มจาก “เดือนล่าสุด” แล้วเรียงย้อนหลังตามเวลา

## การคงค่า (Persistence)

- บันทึกค่าบางอย่างลง `localStorage` ภายใต้คีย์:
  - `detail.threshold`: ค่าร้อยละเกณฑ์ (จำนวนเต็ม 0–100)
  - `detail.compact`: โหมดมินิมอล (true/false)
  - `detail.compactMonths`: จำนวนเดือนในโหมดมินิมอล (3/6/12)

## API ที่ใช้งาน

- `GET /api/v1/branches` — สำหรับ dropdown เลือกสาขา
- `GET /api/v1/custcodes` — รายชื่อ Top‑200 (ข้อมูลบรรยาย)
- `GET /api/v1/details` — หน่วยน้ำรายเดือน (ข้อมูลเชิงตัวเลข)

## งานต่อยอดที่แนะนำ (Optional/Future)

- Export CSV/Excel: ส่งออกข้อมูลตาม “ผลลัพธ์หลังกรอง” (เลือกได้ระหว่าง เฉพาะหน้าปัจจุบัน หรือ ทั้งหมด)
- สรุปย่อ (Summary): รวมยอด active/zeroed และผลรวมหน่วยน้ำ (อิงเอกสาร API `/details/summary`)
- การเรียงลำดับคอลัมน์ในฝั่งหน้าเว็บ หรือสั่งเรียงจากเซิร์ฟเวอร์
- ลิงก์ไปหน้า “ประวัติรายเดือนของรายบุคคล” (`/custcodes/{cust_code}/details`)
- Sticky header/first column เพื่อการอ่านข้อมูลจำนวนมาก

---

เอกสารนี้มุ่งเน้นเชิงพฤติกรรมของระบบ เพื่อให้ทีมออกแบบสามารถสร้าง UI ใหม่ได้สอดคล้องกับฟังก์ชัน และให้ทีมพัฒนาทำงานแยกขนานได้อย่างชัดเจน
